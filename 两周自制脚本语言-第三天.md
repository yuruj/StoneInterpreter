## 两周自制脚本语言-第三天

只要能够通过正则表达式来表达单词的定义，词法分析器的设计就没有太大的困难。Java语言的正则表达式库能够在模式匹配后返回匹配的字符串中的一部分，本书将利用这一功能来实现词法分析器

执行词法分析时，语言处理器将逐行读取源代码，从各行开头起检查内容是否与该正则表达式匹配，并在检查完成后获取与正则表达式括号内的模式相匹配的字符串

> 这么依赖正则表达式，会不会导致执行速度变慢？
>
> 手动设计匹配逻辑也是一样的，并不会有什么区别
>
> 库中的实现经过了大量优化，肯定比自己手动设计性能更好
>
> 与完全手写的词法分析逻辑相比，错误也会减少很多

read与peek是Lexer中主要的两个方法

read方法可以从源代码头部开始逐一获取单词。调用read时将返回一个新的单词

peek方法则用于预读。peek(i)将返回read方法及将返回的单词之后的第i个单词。如果参数i为0，则返回与read方法相同的结果。如果所有单词都已读取，read方法和peek方法都将返回Token.EOF。这是一个特殊的Token对象，用于表示程序结束

在词法分析后需要执行的是语法分析。对语法分析阶段的抽象语法树构造来说，peek方法必不可少。语法分析阶段将一边获取单词一边构造抽象语法树，在中途发现构造有误的时候，需要退回若干个单词，重新构造语法树，这称为回溯。为了支持回溯，语言处理器必须能够取消之前的几次read方法调用，并还原先前的结果。不过，如果要在实现Lexer类时解决这一问题，执行效率会受到影响，因此这里准备了peek方法

peek方法可以事先获取之后将会取得的单词，以此避免撤销AST的构造。也就是说，当遇到分支路线时，不是先随意选取一条，在行不通时再原路返回改走另一条，而是先费一番周折，判断前路是否正确，在确信没有问题的时候才真正继续

> 能否用peek代替read方法
>
> 这关系到内存的占用率。read方法返回的单词不必一直保留，而peek方法必须保存所有返回的单词，内存消耗量更大

要使用peek方法，词法分析器需要在读取代码并获取单词后，将这些单词暂时保存在一个名为queue的ArrayList对象中，之后，peek与read方法会根据需要从中取值并返回。由read方法读取的单词会从queue中删除

> readLine与addToken是词法分析的核心部分，其他都只是起辅助作用，因此词法分析还是比较简单的
>
> 可以用工具来定义单词并自动生成词法分析器
>
> 如果要设计一个真正的语言处理器，最好是使用一些合适的工具。不过Stone语言非常简单，没有这种必要